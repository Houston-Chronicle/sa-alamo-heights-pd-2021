---
title: "R Notebook"
output: html_notebook
---
```{r}
library(tidyverse)
library(janitor)
library(lubridate)
```

getting the real codes!

```{r}
incidents_clean <- incidents %>%
  select(incident_num, date, incident_month, officer, address_clean, desc_clean, starts_with("offense")) %>%
  mutate_all(~str_replace(., "/", "/ ")) %>%
  mutate_all(~(str_replace_all(.,'[\\.,]',''))) %>%
  mutate_all(str_trim) %>%
  group_by(incident_num, date, officer, address_clean) %>%
  rowid_to_column()

incidents_clean
```
So, now I want a situation where I can look at the total number of offenses. The tricky part is differentiating a situation where it's one offense listed in multiple rows OR two different offenses. 

I try to cheat the system by saying that if there are more than two words on the next line, leave it alone. If there are only two words, bring it to the previous row

That doesn't always work out super well. So, I've been guessing and checking the system. Sometimes, I alter the word count so a charge with just two words is seen as one charge. Other times, there are offenses with three or more words that belong with the charge above. 


```{r}
incidents_longer <- incidents_clean %>%
  pivot_longer(cols = c(offenses_clean_p1, offenses_3, offenses_4, offenses_5, offenses_6, offenses_7, offenses_8), names_to = "offenses_gen") %>%
  filter(value != "") %>%
  #filter(value != offenses_clean) %>%
  mutate(value = str_trim(value)) %>%
  mutate(word_cnt = lengths(gregexpr("\\W+", value)) + 1) %>%
  mutate(word_cnt = case_when(
    offenses_clean == value ~ 10,
    value == "PUBLIC INTOXICATION" ~ 10, 
    value == "IMPOUNDED VEHICLE" ~ 10, 
    value == "CRIMINAL TRESPASS" ~ 10, 
    value == "FORGERY" ~ 10, 
    value == "FORGERY/ GOV" ~ 10, 
    value == "AGGRAVATED ROBBERY" ~ 10, 
    value == "ROBBERY" ~ 10, 
    value == "DISTURBANCE" ~ 10, 
    value == "PUBLIC LEWDNESS" ~ 10, 
    value == "RECKLESS DRIVING" ~ 10, 
    value == "INVESTIGATION / INFORMATION" ~ 10, 
    value == "BURGLARY" ~ 10, 
    value == "EMERGENCY DETENTION" ~ 10, 
    value == "DEADLY CONDUCT" ~ 10, 
    value == "HARASSMENT" ~ 10, 
    value == "RECOVERED STOLEN" ~ 10, 
    value == "STALKING" ~ 10, 
    value == "RUNAWAY" ~ 10, 
    value == "WELFARE CHECK" ~ 10, 
    value == "ASSAULT" ~ 10, 
    value == "UNLAWFUL RESTRAINT" ~ 10, 
    value == "THEFT < $50" ~ 10, 
    value == "ILLEGAL DUMPING" ~ 10, 
    value == "DANGER BODILY INJ" ~ 1,
    value == "EVIDENCE - ALTER/DESTROY/CONCEAL" ~ 1,
    value == "OPERATOR/ DRIVERS LICENSE" ~ 1, 
    value == "MORE PREV CONVIC" ~ 1,
    value == "VALID OPERATOR/ DRIVERS LICENSE" ~ 1, 
    value == "IN FEAR OF SBI" ~ 1,
    value == "VEH W/ PREV CONVIC" ~ 1,
    grepl("INFORMATION", value) & grepl("INVESTIGATION", value) ~ 10,
    TRUE ~ word_cnt)) %>%
   mutate(value_clean = case_when(
    lead(word_cnt) <= 2 & word_cnt > 2 & word_cnt != 10 ~ paste(value, lead(value)),
    word_cnt <= 2 & lag(word_cnt) >2 & lag(word_cnt) != 10 ~ "",
    TRUE ~ value
  )) %>%
  mutate(value_clean = case_when(
    lead(value_clean) == "INSPECTION CERT" ~ paste(value_clean, lead(value_clean)), 
    lead(value_clean) == "OBSCURED LICENSE PLATE" ~ paste(value_clean, lead(value_clean)),
    lead(value_clean) == "INSPECTION CERT"  ~ paste(value_clean, lead(value_clean)), 
    lead(value_clean) == "INJURY:FAMILY MEMBER" ~ paste(value_clean, lead(value_clean)), 
    lead(value_clean) == "MONUMENT COMMUNITY CNTR" ~ paste(value_clean, lead(value_clean)),
    lead(value_clean) == "CONSUMP" ~ paste(value_clean, lead(value_clean)),
    lead(value_clean) == "TOUCH:FAMILY MEMBER" ~ paste(value_clean, lead(value_clean)),
    lead(value_clean) == "PROPERTY OF OTHERS" ~ paste(value_clean, lead(value_clean)),
    lead(value_clean) == "W/ INT INHALE" ~ paste(value_clean, lead(value_clean)),
    lead(value_clean) == "VACCINATION OF DOGS CATS AND FERRETS" ~ paste(value_clean, lead(value_clean)),
    lead(value_clean) == "VEH W/PREV CONVIC" ~ paste(value_clean, lead(value_clean)),
    lead(value_clean) == "THAN 4 MONTHS" ~ paste(value_clean, lead(value_clean)),
    lead(value_clean) == "UPON/ OVER STREETS/SIDEWALKS" ~ paste(value_clean, lead(value_clean)),
    lead(value_clean) == "REQUIRED" ~ paste(value_clean, lead(value_clean)),
    lead(value_clean) == "POSS FICT DL OR ID CERT" ~ paste(value_clean, lead(value_clean)),
    lead(value_clean) == "LARGE VEHICLES BOATS AND OTHER" ~ paste(value_clean, lead(value_clean)),
    lead(value_clean) == "ARMOR BY FELON" ~ paste(value_clean, lead(value_clean)),
    value_clean == "FAILED TO COMPLY WITH" ~ paste(value_clean, lead(value_clean)),
    lead(value_clean) == "MORE PREV CONVIC" ~ paste(value_clean, lead(value_clean)),
    lead(value_clean) == "FIXTURE OR HIGHWAY LANDSCAPING" ~ paste(value_clean, lead(value_clean)),
    lead(value_clean) == "2/ MORE PREV CONV" ~paste(value_clean, lead(value_clean)),
    value_clean == ("TAMPER/ FABRICATE PHYSICAL") ~ paste(value_clean, lead(value_clean)),
    TRUE ~ value_clean
  )) %>%
  filter(value_clean != "INSPECTION CERT" & value_clean != "INJURY:FAMILY MEMBER" & value_clean != "MONUMENT COMMUNITY CNTR" & value_clean != "CONSUMP" & value_clean != "TOUCH:FAMILY MEMBER" & value_clean != "PROPERTY OF OTHERS" & value_clean != "W/ INT INHALE" & value_clean != "VACCINATION OF DOGS CATS AND FERRETS" & value_clean != "VEH W/PREV CONVIC" & value_clean != "THAN 4 MONTHS" & value_clean != "UPON/ OVER STREETS/SIDEWALKS" & value_clean != "REQUIRED" & value_clean != "POSS FICT DL OR ID CERT" & value_clean != "OBSCURED LICENSE PLATE", value_clean != "ARMOR BY FELON", value_clean != "REQUIREMENTS ON STRIKING UNATTENDED VEH", value_clean != "FIXTURE OR HIGHWAY LANDSCAPING", value_clean !=  "2/ MORE PREV CONV") %>%
  filter(value_clean != "INSPECTION CERT" & value_clean != "INJURY:FAMILY MEMBER" & value_clean != "MONUMENT COMMUNITY CNTR" & value_clean != "CONSUMP" & value_clean != "TOUCH:FAMILY MEMBER" & value_clean != "PROPERTY OF OTHERS" & value_clean != "W/ INT INHALE" & value_clean != "VACCINATION OF DOGS CATS AND FERRETS" & value_clean != "VEH W/PREV CONVIC" & value_clean != "THAN 4 MONTHS" & value_clean != "UPON/ OVER STREETS/SIDEWALKS" & value_clean != "REQUIRED" & value_clean != "POSS FICT DL OR ID CERT" & value_clean != "OBSCURED LICENSE PLATE", value_clean != "ARMOR BY FELON", value_clean != "REQUIREMENTS ON STRIKING UNATTENDED VEH", value_clean != "FIXTURE OR HIGHWAY LANDSCAPING", value_clean != "EVIDENCE - ALTER/ DESTROY/CONCEAL") %>%
  filter(value_clean != "") %>%
  select(-word_cnt, -offenses_gen, -value, -offenses_2) %>%
  mutate(date = as.Date(date)) %>%
  mutate(incident_month = as.Date(incident_month))

incidents_longer

```


```{r}
#write.csv(incidents_longer, "Data/incidents_longer_for_OpenRefine.csv")
```


```{r}
#clean_offenses <- read_csv("Data/Clean/import/incidents-longer-for-OpenRefineD.csv") 
```

I found a small error with thefts â€” it was with two data points so I went ahead and cleaned that up by editing the original data point and creating two new ones



```{r}
clean_offenses <- incidents_longer %>%
  mutate(value_clean = case_when(
    grepl("OPERATING ALARM", value_clean) ~ "COV - OPERATING ALARM SYSTEM W/ O PERMIT", 
    value_clean == "OPRATING ALARM SYSTEM" | value_clean == "COV - OPERATINGING ALARM SYSTEM W/ O PERMIT" | value_clean == "COV - OPERATE ALARM SYSTEM W/ O PERMIT" | value_clean == "COV - OPERATION ALARM SYSTEM W/ O PERMIT" | value_clean == "COV-OPRATING ALARM SYSTEM W/ O PERMIT" ~ "COV - OPERATING ALARM SYSTEM W/ O PERMIT", 
    grepl("ACCIDENT", value_clean) & grepl("MOTOR VEHICLE", value_clean)  ~ "ACCIDENT MOTOR VEHICLE",
    grepl("CITY CODE VIOLATION", value_clean) ~ "CITY CODE VIOLATION",
    value_clean == "COV - ACCUMULATION OF GARBAGE" ~ "COV - ACCUMULATION OF GARBAGE TRASH WEEDS OR OTHER MATTER",
    value_clean == "TAMPER W/  GOVT RECORD DEFRAUD/ HARM" ~ "TAMPER W/  GOVT RECORD DEFRAUD/HARM",
    value_clean == "COV - ANIMAL NUISANCE - ATTACK OTHER ANIMALS" ~ "ANIMAL NUISANCE",
    value_clean == "COV - IMPOUNDING VEHICLES - ILLEGALLY PARKED OR ABANDONED" ~ "COV - IMPOUNDING VEHICLES -",
    value_clean == "COV - SHRUBBERY/ VEGETATION UPON/ OVER STREETS/SIDEWALKS" ~ "COV - SHRUBBERY/ VEGETATION UPON/OVER STREETS/SIDEWALKS",
    value_clean == "DISPLAY/ POSSESS ALTERED OPERATOR/ DRIVERS LICENSE" ~ "DISPLAY/ POSSESS ALTERED OPERATOR/DRIVERS LICENSE",
    value_clean == "DISPLAY/ POSSESS FICTICIOUS OPERATOR/ DRIVERS LICENSE" ~ "DISPLAY/ POSSESS FICTICIOUS OPERATOR/DRIVERS LICENSE",
    value_clean == "FRAUDULENT USE/ POSS OF IDENTIFYING" ~ "FRAUDULENT USE/ POSS OF IDENTIFYING INFO",
    value_clean == "POSSESSION OF DRUG PARAPHERNALIA" | value_clean == "POSSESSION OR DELIVERY OF DRUG" | value_clean == "POSESSION OF DRUG PARAPHENALIA" ~  "POSSESSION OR DELIVERY OF DRUG PARAPHERNALIA",
    value_clean == "RUNAWAY" ~ "RUNAWAY/ MISSING PERSON",
    TRUE ~ value_clean)) 

# I could attempt to do something to limit two instances where investigation/information are in the thing
 # mutate(value_clean_2 == case_when(
#    grepl("INVESTIGATION", value_clean) & ("INFORMATION", value_clean) ~
 # ))

```
		
Here is the list of offenses I have in my clean dataset

```{r}
types_of_offenses <- clean_offenses %>%
  mutate(year = floor_date(date, unit = "year")) %>%
  #filter(year == as.Date("2021-01-01"))%>%
  group_by(value_clean) %>%
  tally()

types_of_offenses
```
Here is are all of the incidents joined to alamo_codes, the list of codes given by the police department

```{r}
full_incident_code_desc <- clean_offenses %>%
  mutate(year = floor_date(date, unit = "year")) %>%
  #filter(year == as.Date("2021-01-01")) %>%
  inner_join(alamo_codes, by = c("value_clean" = "clean_offenses")) %>%
  select(-rowid) 
  #mutate(street = substr(address_clean, 1, nchar(address_clean)-22)) %>%
  #mutate(city_state_zip = str_sub(address_clean, -22, -1)) %>%
  #mutate(city = substr(city_state_zip, 1, 13)) %>%
  #mutate(state = substr(city_state_zip, 15, 16)) %>%
  #mutate(zip = str_sub(city_state_zip, -5, -1)) %>%
  #select(-city_state_zip)

full_incident_code_desc
```


```{r}
all_incident_code_desc <- clean_offenses %>%
  mutate(year = floor_date(date, unit = "year")) %>%
  #filter(year == as.Date("2021-01-01")) %>%
  inner_join(alamo_codes, by = c("value_clean" = "clean_offenses")) %>%
  select(-rowid) %>%
  group_by(value_clean) %>%
  tally()
  #mutate(street = substr(address_clean, 1, nchar(address_clean)-22)) %>%
  #mutate(city_state_zip = str_sub(address_clean, -22, -1)) %>%
  #mutate(city = substr(city_state_zip, 1, 13)) %>%
  #mutate(state = substr(city_state_zip, 15, 16)) %>%
  #mutate(zip = str_sub(city_state_zip, -5, -1)) %>%
  #select(-city_state_zip)

all_incident_code_desc
```


```{r}
missing_incident_code_desc <- clean_offenses %>%
  mutate(year = floor_date(date, unit = "year")) %>%
  #filter(year == as.Date("2021-01-01")) %>%
  anti_join(alamo_codes, by = c("value_clean" = "clean_offenses")) %>%
  select(-rowid) %>%
  group_by(value_clean) %>%
  tally()
  #mutate(street = substr(address_clean, 1, nchar(address_clean)-22)) %>%
  #mutate(city_state_zip = str_sub(address_clean, -22, -1)) %>%
  #mutate(city = substr(city_state_zip, 1, 13)) %>%
  #mutate(state = substr(city_state_zip, 15, 16)) %>%
  #mutate(zip = str_sub(city_state_zip, -5, -1)) %>%
  #select(-city_state_zip)

missing_incident_code_desc
```


```{r}
missing_incident_code_desc_FULL <- clean_offenses %>%
  mutate(year = floor_date(date, unit = "year")) %>%
  #filter(year == as.Date("2021-01-01")) %>%
  anti_join(alamo_codes, by = c("value_clean" = "clean_offenses")) 
  #filter(grepl("DISPLAY FICTITIOUS / ALTERED", value_clean))

missing_incident_code_desc_FULL
```


Okay, let's categorize by priority/class

```{r}
classified <- full_incident_code_desc %>%
  mutate(category = case_when(
    class == "FELONY" | priority == "HIGH" | priority == "VERY HIGH" ~ "high",
    class == "MISD" | priority == "MED" ~ "medium",
    class == "OTHER" | priority == "LOW" ~ "low", 
    TRUE ~ "unknown"
  ))

classified
```

```{r}
classified_codes <- full_incident_code_desc %>%
  group_by(value_clean, type, nibr, ucr, class, priority) %>%
  tally()

classified_codes
```

EXPORT THIS LIST OF CLASSIFIED CODES with the FBI and PD info ... then use that to give your categorizations


```{r}
#clean_geocoded <- read_csv("Data/full_incident_code_desc_2021_geocodio_2d93e84d1b6357f5f0d652bef414d4567c7565dc.csv") %>%
 # select(-value_clean, -desc_clean, -type, -nibr, -ucr, -priority, -class) %>%
#  distinct()

#clean_geocoded
```


```{r}
#write_csv(clean_geocoded, "Data/Exports/clean_geocoded.csv")
```


```{r}
write_csv(missing_incident_code_desc, "Data/Exports/missing_incident_code_desc__not_paired_with_alamo_codes.csv")
write_csv(classified_codes, "Data/Exports/Alamo_codes_2011_thru_2021_LS_labeled_categories.csv")
```









